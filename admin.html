<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - QC Sweepstakes</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .admin-container h2 {
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .event-card {
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin: 10px 0;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .event-actions button {
            margin-right: 10px;
            padding: 6px 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id="header-container"></div>
    <main>
        <center>
            <h1>Admin Login</h1>

            <div class="admin-container">
                <h2>Admin Login</h2>
                <div id="login-form">
                    <input type="text" id="admin-username" placeholder="Username (Email)"><br><br>
                    <input type="password" id="admin-password" placeholder="Password"><br><br>
                    <button id="login-btn" onclick="loginWithEmailPassword()">Login</button>
                    <p id="login-status" style="color:red;"></p>
                </div>
            </div>

            <!--  PASSCODE LOGIN FORM -->
            <div class="admin-container hidden" id="passcode-form">
                <h2>Enter Admin Passcode</h2>
                <div id="passcode-form-inner">
                    <input type="password" id="admin-pass" placeholder="Enter Admin Passcode">
                    <button onclick="checkLogin()">Login</button>
                </div>
            </div>

            <!-- CREATE EVENT AND MANAGE EVENTS SECTION (HIDDEN INITIALLY) -->
            <div id="admin-panel" class="admin-container hidden">
                <h2>Post Event</h2>
                <label>Event Title:</label><br>
                <input type="text" id="event-title" placeholder="Title"><br><br>


                <label>Event Link (optional):</label><br>
                <input type="text" id="event-link" placeholder="https://..."><br><br>


                <label>Event Details:</label><br>
                <textarea id="event-description" placeholder="Enter details here..." rows="5"
                    cols="30"></textarea><br><br>

                <button id="log-event" onclick="createEvent()">Post Event</button>


                <h2>Update Countdown</h2>
                <label>Countdown End Time:</label><br>
                <input type="datetime-local" id="target-time"><br><br>
                <label>Entry Link:</label><br>
                <input type="text" id="entry-link" placeholder="https://..."><br><br>
                <button id="update-countdown">Update Countdown</button><br><br>
                <hr>
                <h3>Manage Events</h3>
                <div id="events-list">Loading...</div>
            </div>


        </center>


    </main>

    <div id="footer-container"></div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD-giQ4CGXX6F0RIXbAzbp_0vDDomoLo8g",
            authDomain: "qcsweeps-4b994.firebaseapp.com",
            databaseURL: "https://qcsweeps-4b994-default-rtdb.firebaseio.com",
            projectId: "qcsweeps-4b994",
            storageBucket: "qcsweeps-4b994.appspot.com",
            messagingSenderId: "810241609281",
            appId: "1:810241609281:web:63ecd22b6acbee2cf480c0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const loginForm = document.getElementById("login-form");
        const adminPanel = document.getElementById("admin-panel");
        const eventsList = document.getElementById("events-list");
        const usernamePasswordForm = document.getElementById("username-password-form");
        const passcodeForm = document.getElementById("passcode-form");

        function loginWithEmailPassword() {
            const email = document.getElementById("admin-username").value;
            const password = document.getElementById("admin-password").value;
            const loginStatus = document.getElementById("login-status");

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    console.log("Logged in:", user);
                    loginStatus.textContent = "Login Successful!";
                    loginStatus.style.color = "green";
                    // Hide the username/password form
                    usernamePasswordForm.classList.add("hidden");
                    //Show the admin passcode form
                    passcodeForm.classList.remove("hidden");
                    // You might want to store the user's information or redirect to a different page
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error("Login Error:", errorCode, errorMessage);
                    loginStatus.textContent = "Login Failed: " + errorMessage;
                    loginStatus.style.color = "red";
                });
        }


        function checkLogin() {
            const entered = document.getElementById("admin-pass").value;
            const passRef = db.ref("adminPasscode");
            passRef.once("value", snapshot => {
                if (snapshot.val() === entered) {
                    passcodeForm.classList.add("hidden");
                    adminPanel.classList.remove("hidden");
                    loadEvents();
                } else {
                    alert("Incorrect passcode");
                }
            });
        }


        function createEvent() {
            const title = document.getElementById("event-title").value;
            const description = document.getElementById("event-description").value;
            const link = document.getElementById("event-link").value;
            const newEvent = { title, description, link };
            db.ref("events").push(newEvent);

            if (!title || !description) return alert("Title and description required.");

            document.getElementById("event-title").value = "";
            document.getElementById("event-description").value = "";
            document.getElementById("event-link").value = "";
        }


        function loadEvents() {
            db.ref("events").on("value", snapshot => {
                const data = snapshot.val();
                eventsList.innerHTML = "";
                if (data) {
                    Object.entries(data).reverse().forEach(([key, event]) => {
                        const div = document.createElement("div");
                        div.className = "event-card";
                        div.innerHTML = `
              <strong>Title:</strong> <span contenteditable="false">\${event.title}</span><br>
              <strong>Description:</strong> <span contenteditable="false">\${event.description || ""}</span><br>
              ${event.link ? `<strong>Link:</strong> <a href="${event.link}" target="_blank">${event.link}</a><br>` : ""}
              <div class="event-actions">
                <button onclick="enableEdit('\${key}', this)">Edit</button>
                <button onclick="deleteEvent('\${key}')">Delete</button>
              </div>
            `;
                        eventsList.appendChild(div);
                    });
                } else {
                    eventsList.innerHTML = "<p>No events found.</p>";
                }
            });
        }

        function enableEdit(key, btn) {
            const card = btn.closest(".event-card");
            const spans = card.querySelectorAll("span[contenteditable]");
            const editing = btn.textContent === "Save";

            if (editing) {
                const [titleEl, descEl] = spans;
                const updatedEvent = {
                    title: titleEl.textContent.trim(),
                    description: descEl.textContent.trim()
                };
                db.ref("events/" + key).update(updatedEvent);
                btn.textContent = "Edit";
                spans.forEach(el => el.setAttribute("contenteditable", false));
            } else {
                console.error("Failed to load", url);
                btn.textContent = "Save";
                spans.forEach(el => el.setAttribute("contenteditable", true));
            }
        }

        function deleteEvent(key) {
            if (confirm("Are you sure you want to delete this event?")) {
                db.ref("events/" + key).remove();
            }
        }

        async function loadHTML(selector, url) {
            const response = await fetch(url);
            if (response.ok) {
                const html = await response.text();
                document.querySelector(selector).innerHTML = html;
            } else {
                console.error("Failed to load", url);
            }
        }


        loadHTML("#header-container", "header-admin.html");
        loadHTML("#footer-container", "footer.html");
    </script>
    <script type="module" src="script.js"></script>
</body>

</html>
